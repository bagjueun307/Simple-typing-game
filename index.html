<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4분할 실시간 타자 게임</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        
        /* 상단 UI */
        #top-bar { height: 70px; display: flex; justify-content: space-around; align-items: center; background: #333; border-bottom: 4px solid #444; }
        .timer-box { font-size: 2rem; font-weight: bold; color: #00ff00; }
        .team-indicator { padding: 8px 20px; border-radius: 25px; font-weight: bold; font-size: 1.2rem; transition: 0.3s; }

        /* 게임 보드 */
        #game-container { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: calc(100vh - 160px); gap: 15px; padding: 15px; position: relative; }
        
        .monitor { background: #252525; border: 5px solid #444; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; cursor: pointer; position: relative; }
        .monitor.active-turn { border-color: #00ff00; box-shadow: 0 0 20px rgba(0, 255, 0, 0.4); }
        
        /* 확대 시 스타일 */
        .monitor.expanded { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: #1a1a1a; padding: 20px; box-sizing: border-box; }

        .monitor-label { text-align: center; padding: 5px; background: #333; font-size: 0.8rem; color: #aaa; }

        /* 4x4 그리드 */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); gap: 10px; flex-grow: 1; padding: 10px; }
        .cell { background: #3d3d3d; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; transition: transform 0.4s, background-color 0.4s; box-shadow: inset 0 -3px 0 rgba(0,0,0,0.2); }

        /* 팀 점유 색상 */
        .occupied-1 { background-color: #e74c3c !important; transform: rotateY(360deg); } /* 레드 */
        .occupied-2 { background-color: #3498db !important; transform: rotateY(360deg); } /* 블루 */
        .occupied-3 { background-color: #f1c40f !important; color: #000 !important; transform: rotateY(360deg); } /* 옐로 */
        .occupied-4 { background-color: #9b59b6 !important; transform: rotateY(360deg); } /* 퍼플 */

        /* 하단 입력창 */
        #input-area { height: 90px; display: flex; justify-content: center; align-items: center; background: #222; border-top: 2px solid #333; }
        #word-input { width: 400px; padding: 15px; font-size: 1.5rem; border-radius: 10px; border: none; text-align: center; background: #000; color: #00ff00; border: 2px solid #444; }
        #word-input:focus { border-color: #00ff00; outline: none; }
    </style>
</head>
<body>

<div id="top-bar">
    <div>현재 차례: <span id="current-team-ui" class="team-indicator">TEAM 1</span></div>
    <div class="timer-box" id="timer">10</div>
    <div id="score-board">T1:<span id="s1">0</span> | T2:<span id="s2">0</span> | T3:<span id="s3">0</span> | T4:<span id="s4">0</span></div>
</div>

<div id="game-container">
    <div class="monitor" id="m1" onclick="toggleExpand('m1')"><div class="monitor-label">MONITOR 1</div><div class="grid" id="grid1"></div></div>
    <div class="monitor" id="m2" onclick="toggleExpand('m2')"><div class="monitor-label">MONITOR 2</div><div class="grid" id="grid2"></div></div>
    <div class="monitor" id="m3" onclick="toggleExpand('m3')"><div class="monitor-label">MONITOR 3</div><div class="grid" id="grid3"></div></div>
    <div class="monitor" id="m4" onclick="toggleExpand('m4')"><div class="monitor-label">MONITOR 4</div><div class="grid" id="grid4"></div></div>
</div>

<div id="input-area">
    <input type="text" id="word-input" placeholder="자기 팀 차례에 입력!" autocomplete="off">
</div>

<script>
    // 1. Firebase 구성 (콘솔에서 확인한 정보를 넣으세요)
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY", // 실제 API Key를 넣어야 합니다.
        authDomain: "simple-typing-game-cfe6f.firebaseapp.com",
        databaseURL: "https://simple-typing-game-cfe6f-default-rtdb.firebaseio.com/",
        projectId: "simple-typing-game-cfe6f",
        storageBucket: "simple-typing-game-cfe6f.appspot.com",
        appId: "YOUR_APP_ID" // 실제 App ID를 넣어야 합니다.
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 공통 단어 리스트
    const words = ["사과", "바나나", "포도", "수박", "기차", "하늘", "바다", "농구", "축구", "컴퓨터", "우주", "별빛", "태양", "구름", "노래", "피아노"];
    let expandedId = null;
    let currentTeam = 1;

    // 2. 데이터베이스 초기화 (데이터가 없을 때만 실행)
    db.ref('gameStatus').once('value', (snap) => {
        if (!snap.exists()) {
            db.ref('gameStatus').set({ currentTeam: 1, timeLeft: 10 });
            let initialBoard = {};
            words.forEach(w => initialBoard[w] = 0);
            db.ref('board').set(initialBoard);
        }
    });

    // 3. 실시간 리스너: 보드 상태 업데이트
    db.ref('board').on('value', (snapshot) => {
        const boardData = snapshot.val();
        if (boardData) renderAllGrids(boardData);
    });

    // 4. 실시간 리스너: 턴 및 타이머 업데이트
    db.ref('gameStatus').on('value', (snapshot) => {
        const status = snapshot.val();
        if (status) {
            currentTeam = status.currentTeam;
            document.getElementById('timer').innerText = status.timeLeft;
            const ui = document.getElementById('current-team-ui');
            ui.innerText = `TEAM ${currentTeam}`;
            ui.style.backgroundColor = getTeamColor(currentTeam);
            
            // 현재 팀 모니터 강조
            document.querySelectorAll('.monitor').forEach(m => m.classList.remove('active-turn'));
            document.getElementById(`m${currentTeam}`).classList.add('active-turn');
        }
    });

    function renderAllGrids(boardData) {
        const scores = {1:0, 2:0, 3:0, 4:0};
        for (let m = 1; m <= 4; m++) {
            const grid = document.getElementById(`grid${m}`);
            grid.innerHTML = '';
            words.forEach(word => {
                const teamNum = boardData[word];
                const cell = document.createElement('div');
                cell.className = 'cell';
                if (teamNum > 0) {
                    cell.classList.add(`occupied-${teamNum}`);
                    if (m === 1) scores[teamNum]++; // 중복 계산 방지 위해 한 번만 체크
                }
                cell.innerText = word;
                grid.appendChild(cell);
            });
        }
        // 점수 업데이트
        for(let i=1; i<=4; i++) document.getElementById(`s${i}`).innerText = scores[i];
    }

    // 5. 단어 입력 로직
    const inputField = document.getElementById('word-input');
    inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const val = inputField.value.trim();
            if (words.includes(val)) {
                // DB에 해당 단어를 현재 팀의 번호로 저장
                db.ref(`board/${val}`).set(currentTeam);
            }
            inputField.value = '';
        }
    });

    // 6. 타이머 서버 로직 (가장 먼저 접속한 사람이나 관리자 기기에서 실행)
    // 실제로는 한 명만 실행해야 하지만, transaction을 사용하면 여러 명이 실행해도 안전합니다.
    setInterval(() => {
        db.ref('gameStatus').transaction((current) => {
            if (current) {
                if (current.timeLeft <= 1) {
                    current.timeLeft = 10;
                    current.currentTeam = (current.currentTeam % 4) + 1;
                } else {
                    current.timeLeft--;
                }
            }
            return current;
        });
    }, 1000);

    function toggleExpand(id) {
        const el = document.getElementById(id);
        if (expandedId === id) { el.classList.remove('expanded'); expandedId = null; }
        else {
            if (expandedId) document.getElementById(expandedId).classList.remove('expanded');
            el.classList.add('expanded'); expandedId = id;
        }
    }

    function getTeamColor(num) {
        const colors = ["", "#e74c3c", "#3498db", "#f1c40f", "#9b59b6"];
        return colors[num];
    }
</script>
</body>
</html>