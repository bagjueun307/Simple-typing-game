<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4분할 실시간 타자 게임</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; }
        #top-bar { height: 70px; display: flex; justify-content: space-around; align-items: center; background: #333; border-bottom: 3px solid #444; }
        .timer-display { font-size: 2.2rem; font-weight: bold; color: #00ff00; }
        .team-badge { padding: 5px 15px; border-radius: 20px; font-weight: bold; transition: 0.3s; }
        
        #game-container { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: calc(100vh - 150px); gap: 10px; padding: 10px; position: relative; }
        .monitor { background: #252525; border: 4px solid #444; border-radius: 8px; display: flex; flex-direction: column; cursor: pointer; position: relative; overflow: hidden; transition: 0.3s; }
        .monitor.active-turn { border-color: #00ff00; box-shadow: 0 0 15px rgba(0,255,0,0.4); }
        .monitor.expanded { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: #1a1a1a; }
        
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex-grow: 1; padding: 10px; }
        .cell { background: #3d3d3d; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; transition: 0.3s; text-align: center; }
        
        /* 팀별 색상 */
        .t1 { background-color: #e74c3c !important; }
        .t2 { background-color: #3498db !important; }
        .t3 { background-color: #f1c40f !important; color: black !important; }
        .t4 { background-color: #9b59b6 !important; }

        #input-area { height: 80px; display: flex; justify-content: center; align-items: center; background: #222; }
        #word-input { width: 350px; padding: 12px; font-size: 1.3rem; border-radius: 8px; border: none; text-align: center; outline: none; }
    </style>
</head>
<body>

<div id="top-bar">
    <div>현재 턴: <span id="team-ui" class="team-badge">연결 중...</span></div>
    <div class="timer-display" id="timer">--</div>
    <div id="score">T1:<span id="s1">0</span> T2:<span id="s2">0</span> T3:<span id="s3">0</span> T4:<span id="s4">0</span></div>
</div>

<div id="game-container">
    <div class="monitor" id="m1" onclick="toggleExpand('m1')"><div class="grid" id="grid1"></div></div>
    <div class="monitor" id="m2" onclick="toggleExpand('m2')"><div class="grid" id="grid2"></div></div>
    <div class="monitor" id="m3" onclick="toggleExpand('m3')"><div class="grid" id="grid3"></div></div>
    <div class="monitor" id="m4" onclick="toggleExpand('m4')"><div class="grid" id="grid4"></div></div>
</div>

<div id="input-area">
    <input type="text" id="word-input" placeholder="자기 팀 턴일 때 단어를 입력!" autocomplete="off">
</div>

<script>
    // 사용자님의 실제 설정값을 적용했습니다.
    const firebaseConfig = {
        apiKey: "AIzaSyAeR0VBUUJp2iQyXw0jBtz3kf2KuQwpPEQ",
        authDomain: "simple-typing-game-cfe6f.firebaseapp.com",
        databaseURL: "https://simple-typing-game-cfe6f-default-rtdb.firebaseio.com",
        projectId: "simple-typing-game-cfe6f",
        storageBucket: "simple-typing-game-cfe6f.firebasestorage.app",
        messagingSenderId: "930923605778",
        appId: "1:930923605778:web:80cbe48118055a95134dcb",
        measurementId: "G-181REZBN5J"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const words = ["사과", "바나나", "포도", "수박", "기차", "하늘", "바다", "농구", "축구", "컴퓨터", "우주", "별빛", "태양", "구름", "노래", "피아노"];
    let expandedId = null;
    let currentTeam = 1;

    // 1. 초기 데이터 구조 생성
    db.ref('game').once('value', (snap) => {
        if (!snap.exists()) {
            let initialBoard = {}; words.forEach(w => initialBoard[w] = 0);
            db.ref('game').set({
                status: { currentTeam: 1, timeLeft: 10 },
                board: initialBoard
            });
        }
    });

    // 2. 실시간 데이터 동기화
    db.ref('game').on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        currentTeam = data.status.currentTeam;
        document.getElementById('timer').innerText = data.status.timeLeft;
        const ui = document.getElementById('team-ui');
        ui.innerText = `TEAM ${currentTeam}`;
        ui.className = `team-badge t${currentTeam}`;

        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('active-turn'));
        document.getElementById(`m${currentTeam}`).classList.add('active-turn');

        const scores = {1:0, 2:0, 3:0, 4:0};
        for (let m = 1; m <= 4; m++) {
            const grid = document.getElementById(`grid${m}`);
            grid.innerHTML = '';
            words.forEach(word => {
                const owner = data.board[word];
                const cell = document.createElement('div');
                cell.className = 'cell' + (owner > 0 ? ` t${owner}` : '');
                cell.innerText = word;
                grid.appendChild(cell);
                if (m === 1 && owner > 0) scores[owner]++;
            });
        }
        for(let i=1; i<=4; i++) document.getElementById(`s${i}`).innerText = scores[i];
    });

    // 3. 단어 입력 처리
    document.getElementById('word-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const val = e.target.value.trim();
            if (words.includes(val)) {
                db.ref(`game/board/${val}`).set(currentTeam);
            }
            e.target.value = '';
        }
    });

    // 4. 전역 타이머 (transaction으로 정확히 관리)
    setInterval(() => {
        db.ref('game/status').transaction((current) => {
            if (current) {
                if (current.timeLeft <= 1) {
                    current.timeLeft = 10;
                    current.currentTeam = (current.currentTeam % 4) + 1;
                } else {
                    current.timeLeft--;
                }
            }
            return current;
        });
    }, 1000);

    function toggleExpand(id) {
        const el = document.getElementById(id);
        if (expandedId === id) { el.classList.remove('expanded'); expandedId = null; }
        else {
            if (expandedId) document.getElementById(expandedId).classList.remove('expanded');
            el.classList.add('expanded'); expandedId = id;
        }
    }
</script>
</body>
</html>
